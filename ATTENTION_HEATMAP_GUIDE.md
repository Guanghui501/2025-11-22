# æ³¨æ„åŠ›çƒ­å›¾åæ ‡è½´è¯¦è§£

## ğŸ“Š åæ ‡è½´å«ä¹‰

### Yè½´ï¼šGraph Nodes (Atoms) - åŸå­ç´¢å¼•

**å«ä¹‰**ï¼šæ™¶ä½“ç»“æ„ä¸­æ¯ä¸ªåŸå­çš„ç´¢å¼•å·

**ç¤ºä¾‹**ï¼š
```
Yè½´åˆ»åº¦    å¯¹åº”å†…å®¹
   0       ç¬¬1ä¸ªåŸå­ï¼ˆç´¢å¼•0ï¼‰
   1       ç¬¬2ä¸ªåŸå­ï¼ˆç´¢å¼•1ï¼‰
   2       ç¬¬3ä¸ªåŸå­ï¼ˆç´¢å¼•2ï¼‰
   ...     ...
   27      ç¬¬28ä¸ªåŸå­ï¼ˆç´¢å¼•27ï¼‰
```

**å…·ä½“ä¿¡æ¯**ï¼š
- æ•°å­—åªæ˜¯ç´¢å¼•ï¼Œä¸ç›´æ¥æ˜¾ç¤ºå…ƒç´ ç±»å‹
- å®é™…å…ƒç´ éœ€è¦æŸ¥çœ‹æ™¶ä½“ç»“æ„æ•°æ®
- ä¾‹å¦‚å¯¹äº BaTiOâ‚ƒï¼š
  ```
  ç´¢å¼• 0-4   â†’ Ba åŸå­
  ç´¢å¼• 5-9   â†’ Ti åŸå­
  ç´¢å¼• 10-27 â†’ O åŸå­
  ```

### Xè½´ï¼šText Tokens - æ–‡æœ¬tokenä½ç½®

**å«ä¹‰**ï¼šæ–‡æœ¬æè¿°ç»è¿‡BERTåˆ†è¯åçš„tokenåºåˆ—

**BERTåˆ†è¯ç¤ºä¾‹**ï¼š
```
åŸå§‹æ–‡æœ¬ï¼š
"Barium titanium oxide is a perovskite material"

BERTåˆ†è¯åï¼š
Token 0:  [CLS]         # ç‰¹æ®Šå¼€å§‹ç¬¦å·
Token 1:  Barium
Token 2:  titanium
Token 3:  oxide
Token 4:  is
Token 5:  a
Token 6:  per
Token 7:  ##ov
Token 8:  ##skite      # ## è¡¨ç¤ºå­è¯
Token 9:  material
Token 10: [SEP]         # ç‰¹æ®Šç»“æŸç¬¦å·
```

**æ³¨æ„**ï¼š
- Token â‰  å•è¯ï¼ˆä¸€ä¸ªè¯å¯èƒ½è¢«åˆ†æˆå¤šä¸ªtokenï¼‰
- `##` å‰ç¼€è¡¨ç¤ºå­è¯ï¼ˆword pieceï¼‰
- `[CLS]` å’Œ `[SEP]` æ˜¯ç‰¹æ®Štoken

## ğŸ¨ çƒ­å›¾è§£è¯»ç¤ºä¾‹

### å½“å‰çƒ­å›¾ï¼ˆåªæœ‰æ•°å­—ç´¢å¼•ï¼‰

```
         0    5    10   15   20   ...   (Xè½´ï¼šTokenç´¢å¼•)
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   0  â”‚ 0.02 0.01 0.35 0.08 0.05 ...  â”‚  ç¬¬1ä¸ªåŸå­
   1  â”‚ 0.03 0.02 0.32 0.09 0.06 ...  â”‚  ç¬¬2ä¸ªåŸå­
   2  â”‚ 0.02 0.01 0.38 0.07 0.04 ...  â”‚  ç¬¬3ä¸ªåŸå­
  ... â”‚ ...  ...  ...  ...  ...  ...  â”‚
  15  â”‚ 0.15 0.08 0.05 0.28 0.12 ...  â”‚  ç¬¬16ä¸ªåŸå­
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(Yè½´ï¼šåŸå­ç´¢å¼•)
```

**è§£è¯»å›°éš¾**ï¼š
- âŒ ä¸çŸ¥é“åŸå­0æ˜¯ä»€ä¹ˆå…ƒç´ 
- âŒ ä¸çŸ¥é“token 10æ˜¯ä»€ä¹ˆè¯
- âŒ éœ€è¦é¢å¤–æŸ¥çœ‹æ•°æ®æ‰èƒ½ç†è§£

### å¢å¼ºç‰ˆçƒ­å›¾ï¼ˆæ˜¾ç¤ºå®é™…æ ‡ç­¾ï¼‰

```
              [CLS] Barium Ti    oxide per##ov##skite ...
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    Ba-0 â”‚ 0.02  0.35   0.05  0.08   0.01  0.02  ...  â”‚  BaåŸå­
    Ba-1 â”‚ 0.03  0.32   0.06  0.09   0.02  0.01  ...  â”‚  BaåŸå­
    Ba-2 â”‚ 0.02  0.38   0.04  0.07   0.01  0.03  ...  â”‚  BaåŸå­
    Ti-5 â”‚ 0.01  0.05   0.35  0.04   0.02  0.28  ...  â”‚  TiåŸå­
    Ti-6 â”‚ 0.02  0.06   0.32  0.05   0.03  0.25  ...  â”‚  TiåŸå­
     O-10â”‚ 0.01  0.02   0.03  0.42   0.01  0.02  ...  â”‚  OåŸå­
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§£è¯»æ¸…æ™°**ï¼š
- âœ… ç›´æ¥çœ‹åˆ°BaåŸå­ä¸»è¦å…³æ³¨"Barium"tokenï¼ˆ0.35-0.38ï¼‰
- âœ… TiåŸå­å…³æ³¨"Ti"å’Œ"##skite"ï¼ˆé’›é…¸ç›ï¼‰
- âœ… OåŸå­å…³æ³¨"oxide"ï¼ˆ0.42ï¼‰
- âœ… å¯ä»¥ç›´æ¥ç†è§£åŒ–å­¦è¯­ä¹‰å¯¹åº”å…³ç³»

## ğŸ” å¦‚ä½•åˆ†æçƒ­å›¾

### 1. è¯†åˆ«å—çŠ¶ç»“æ„ï¼ˆBlock Patternsï¼‰

**å¥½çš„æ³¨æ„åŠ›æ¨¡å¼**ï¼š
```
åŒç±»åŸå­ â†’ ç›¸åŒçš„å…³é”®è¯

ä¾‹å¦‚ï¼šBaTiOâ‚ƒçš„ç†æƒ³æ³¨æ„åŠ›æ¨¡å¼ï¼š

              Ba  Ti  O  oxide metal ...
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    Ba   â”‚ ğŸ”´  âšª  âšª  âšª    ğŸŸ¡   ...  â”‚  Ba â†’ "Ba", "metal"
    Ba   â”‚ ğŸ”´  âšª  âšª  âšª    ğŸŸ¡   ...  â”‚
    Ti   â”‚ âšª  ğŸ”´  âšª  âšª    ğŸŸ¡   ...  â”‚  Ti â†’ "Ti", "metal"
    Ti   â”‚ âšª  ğŸ”´  âšª  âšª    ğŸŸ¡   ...  â”‚
    O    â”‚ âšª  âšª  âšª  ğŸ”´    âšª   ...  â”‚  O â†’ "oxide"
    O    â”‚ âšª  âšª  âšª  ğŸ”´    âšª   ...  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”´ = é«˜æ³¨æ„åŠ›ï¼ˆæ·±çº¢è‰²ï¼‰
ğŸŸ¡ = ä¸­ç­‰æ³¨æ„åŠ›ï¼ˆæ©™è‰²ï¼‰
âšª = ä½æ³¨æ„åŠ›ï¼ˆæµ…è‰²ï¼‰
```

**ç‰¹å¾**ï¼š
- æ¸…æ™°çš„çº¢è‰²æ–¹å—ï¼ˆåŒç±»åŸå­Ã—ç›¸å…³è¯æ±‡ï¼‰
- é«˜å¯¹æ¯”åº¦ï¼ˆæ·±æµ…åˆ†æ˜ï¼‰
- è¯­ä¹‰ä¸€è‡´æ€§ï¼ˆåŒ–å­¦ä¸Šæœ‰æ„ä¹‰ï¼‰

### 2. æ¯”è¾ƒä¸¤ä¸ªæ¨¡å‹çš„å·®å¼‚

**å…¨æ¨¡æ€æ¨¡å‹ï¼ˆå¥½ï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ğŸ”´âšªâšªâšªâšª  â”‚  æ¸…æ™°çš„çº¢è‰²å—
â”‚ ğŸ”´ğŸ”´âšªâšªâšªâšª  â”‚  é«˜å¯¹æ¯”åº¦
â”‚ âšªâšªğŸ”´ğŸ”´âšªâšª  â”‚  ç»“æ„åˆ†æ˜
â”‚ âšªâšªğŸ”´ğŸ”´âšªâšª  â”‚
â”‚ âšªâšªâšªâšªğŸ”´ğŸ”´  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ— ä¸­æœŸèåˆæ¨¡å‹ï¼ˆå·®ï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¡ğŸŸ¡ğŸŸ ğŸŸ ğŸŸ¡ğŸŸ¡  â”‚  é¢œè‰²æ•´ä½“è¾ƒæµ…
â”‚ ğŸŸ¡ğŸŸ ğŸŸ¡ğŸŸ ğŸŸ¡ğŸŸ¡  â”‚  åˆ†å¸ƒè¾ƒå‡åŒ€
â”‚ ğŸŸ ğŸŸ¡ğŸŸ¡ğŸŸ ğŸŸ¡ğŸŸ   â”‚  æ²¡æœ‰æ˜æ˜¾ç»“æ„
â”‚ ğŸŸ¡ğŸŸ¡ğŸŸ ğŸŸ¡ğŸŸ ğŸŸ¡  â”‚  å¯¹æ¯”åº¦ä½
â”‚ ğŸŸ¡ğŸŸ ğŸŸ¡ğŸŸ¡ğŸŸ¡ğŸŸ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å®šé‡åˆ†æçƒ­å›¾

**è®¡ç®—æ¯è¡Œï¼ˆåŸå­ï¼‰çš„ç»Ÿè®¡**ï¼š

```python
# å¯¹äºæ¯ä¸ªåŸå­ï¼ˆæ¯è¡Œï¼‰
for atom_idx in range(num_atoms):
    attention_weights = heatmap[atom_idx, :]

    # 1. ç†µï¼ˆé›†ä¸­åº¦ï¼‰
    entropy = -sum(w * log(w) for w in attention_weights)
    # è¶Šä½ = è¶Šé›†ä¸­

    # 2. æœ€å¤§æƒé‡
    max_weight = max(attention_weights)
    # è¶Šé«˜ = å¯¹æŸä¸ªtokenè¶Šç¡®ä¿¡

    # 3. æœ€å¤§æƒé‡çš„tokenä½ç½®
    max_token_idx = argmax(attention_weights)
    # çœ‹è¿™ä¸ªåŸå­æœ€å…³æ³¨å“ªä¸ªè¯

    # 4. æœ‰æ•ˆtokenæ•°
    effective_tokens = sum(w > 0.1 for w in attention_weights)
    # è¶Šå°‘ = è¶Šæœ‰é€‰æ‹©æ€§
```

**ç¤ºä¾‹åˆ†æ**ï¼š
```
åŸå­5ï¼ˆTiï¼‰çš„æ³¨æ„åŠ›åˆ†å¸ƒï¼š
  Token:     Ba    Ti   oxide  metal  ...
  Weight:   0.05  0.45  0.08   0.12   ...

  ç†µ = 1.85           ï¼ˆä½ = é›†ä¸­ï¼‰
  æœ€å¤§æƒé‡ = 0.45     ï¼ˆé«˜ = ç¡®ä¿¡ï¼‰
  æœ€å…³æ³¨ = Token 1 "Ti"ï¼ˆæ­£ç¡®ï¼ï¼‰
  æœ‰æ•ˆtoken = 3       ï¼ˆå°‘ = é€‰æ‹©æ€§å¼ºï¼‰

â†’ è¿™æ˜¯ä¸€ä¸ªé«˜è´¨é‡çš„æ³¨æ„åŠ›æ¨¡å¼ï¼
```

## ğŸ“ˆ è®ºæ–‡ä¸­å¦‚ä½•æè¿°

### æ–¹æ³•1ï¼šæ•´ä½“æ¨¡å¼æè¿°

```markdown
Figure X shows the atom-token attention heatmaps. The full model
(left) exhibits clear block-structured patterns: Ba atoms (rows 0-4)
form a dark red block when attending to "Barium" tokens (column 8),
Ti atoms (rows 10-18) focus on "titanium" and "metal" tokens
(columns 15-20), and O atoms show strong attention to "oxide"
tokens. In contrast, the no-middle-fusion model (right) produces
diffuse, uniform attention patterns without discernible structure.
```

### æ–¹æ³•2ï¼šå…·ä½“å…ƒç´ åˆ†æ

```markdown
**Element-Specific Attention Patterns:**

- **Ba atoms (rows 0-4)**: In the full model, these atoms assign
  78% of their total attention to element-specific tokens ("barium":
  0.35, "alkaline": 0.28, "earth": 0.15), with maximum weight 0.35
  at token 8 ("Barium"). The no-middle model shows scattered
  attention (max weight 0.12) without clear focus.

- **Ti atoms (rows 10-18)**: The full model creates a distinct red
  block (attention >0.3) over tokens 15-20 ("titanium", "transition",
  "metal"), demonstrating strong semantic alignment. The no-middle
  model fails to establish this correspondence (max weight 0.15).

- **O atoms (rows 20-35)**: Both models attend to "oxide" tokens,
  but the full model shows much stronger, more concentrated
  attention (0.42 vs 0.18), with lower entropy (1.65 vs 2.98).
```

### æ–¹æ³•3ï¼šåŒ–å­¦æ„ä¹‰è¿æ¥

```markdown
The attention patterns align with chemical intuition: Ba atoms,
being large alkaline earth metals, correctly attend to size-related
("large", "radius") and chemical property ("electropositive",
"ionic") descriptors. Ti atoms focus on coordination-related terms
("octahedral", "d-orbital"), reflecting their typical coordination
environment. This demonstrates that the model learns chemically
meaningful atom-text alignments rather than spurious correlations.
```

## ğŸ†• ä½¿ç”¨å¢å¼ºç‰ˆå¯è§†åŒ–å·¥å…·

æˆ‘åˆ›å»ºäº† `visualize_attention_enhanced.py`ï¼Œå¯ä»¥ç”Ÿæˆå¸¦æœ‰å®é™…æ ‡ç­¾çš„çƒ­å›¾ï¼š

### è¿è¡Œæ–¹æ³•

```bash
bash run_enhanced_visualization.sh
```

æˆ–æ‰‹åŠ¨è¿è¡Œï¼š

```bash
python visualize_attention_enhanced.py \
    --checkpoint_full output_100epochs_42_bs128_sw_ju/mbj_bandgap/best_val_model.pt \
    --checkpoint_no_middle output_100epochs_42_bs128_sw_ju_houqi/mbj_bandgap/best_val_model.pt \
    --root_dir /public/home/ghzhang/crysmmnet-main/dataset/jarvis/mbj_bandgap \
    --dataset dft_3d \
    --property mbj_bandgap \
    --save_dir ./attention_enhanced \
    --num_examples 3
```

### ç”Ÿæˆçš„å¯è§†åŒ–

**1. å¢å¼ºç‰ˆçƒ­å›¾** (`enhanced_heatmap_*.png`)
- Xè½´æ˜¾ç¤ºå®é™…çš„tokenæ–‡æœ¬
- Yè½´æ˜¾ç¤ºåŸå­ç´¢å¼•
- æ›´å®¹æ˜“è§£è¯»atom-tokenå¯¹åº”å…³ç³»

**2. è¯¦ç»†åˆ†æå›¾** (`detailed_analysis_*.png`)
- ä¸»çƒ­å›¾ï¼šä¸¤ä¸ªæ¨¡å‹çš„æ³¨æ„åŠ›å¯¹æ¯”
- ç»Ÿè®¡å›¾ï¼šæ¯ä¸ªåŸå­çš„ç†µå’Œæœ€å¤§æƒé‡
- è¾¹æ ï¼šæ¯ä¸ªåŸå­æœ€å…³æ³¨çš„tokenä½ç½®
- ä¸€å›¾å±•ç¤ºæ‰€æœ‰å…³é”®ä¿¡æ¯

### ä¼˜åŠ¿

âœ… **ç›´è§‚**ï¼šç›´æ¥çœ‹åˆ°"BaåŸå­å…³æ³¨'Barium'è¯"
âœ… **å®Œæ•´**ï¼šåŒæ—¶æ˜¾ç¤ºçƒ­å›¾å’Œç»Ÿè®¡ä¿¡æ¯
âœ… **è®ºæ–‡å¯ç”¨**ï¼šé«˜åˆ†è¾¨ç‡ï¼ˆ300 DPIï¼‰ï¼Œé€‚åˆå‘è¡¨

## ğŸ’¡ æ€»ç»“

### å½“å‰çƒ­å›¾çš„åæ ‡

| è½´ | å«ä¹‰ | æ˜¾ç¤ºå†…å®¹ | å±€é™ |
|----|------|----------|------|
| Yè½´ | åŸå­ | ç´¢å¼•å·ï¼ˆ0, 1, 2, ...ï¼‰ | ä¸çŸ¥é“å…ƒç´ ç±»å‹ |
| Xè½´ | Token | ä½ç½®å·ï¼ˆ0, 1, 2, ...ï¼‰ | ä¸çŸ¥é“å¯¹åº”çš„è¯ |

### å¢å¼ºç‰ˆçƒ­å›¾çš„åæ ‡

| è½´ | å«ä¹‰ | æ˜¾ç¤ºå†…å®¹ | ä¼˜åŠ¿ |
|----|------|----------|------|
| Yè½´ | åŸå­ | ç´¢å¼•å· | å¯ä»¥æ ‡æ³¨å…ƒç´  |
| Xè½´ | Token | å®é™…æ–‡æœ¬ï¼ˆ"Barium", "Ti", ...ï¼‰ | ç›´æ¥çœ‹æ‡‚è¯­ä¹‰ |

### å»ºè®®

1. **åˆ†ææ—¶**ï¼šä½¿ç”¨å¢å¼ºç‰ˆçƒ­å›¾ï¼Œæ›´å®¹æ˜“å‘ç°æ¨¡å¼
2. **è®ºæ–‡ä¸­**ï¼šå¯ä»¥ç”¨å½“å‰çƒ­å›¾ï¼ˆæ›´ç®€æ´ï¼‰ï¼Œä½†åœ¨æ­£æ–‡ä¸­è§£é‡Šåæ ‡å«ä¹‰
3. **è¡¥å……ææ–™**ï¼šæ”¾å¢å¼ºç‰ˆçƒ­å›¾ï¼Œæä¾›å®Œæ•´çš„å¯è§£é‡Šæ€§åˆ†æ

---

**ç¥ä½ åˆ†æé¡ºåˆ©ï¼æœ‰ä»»ä½•é—®é¢˜éšæ—¶é—®æˆ‘ã€‚**
